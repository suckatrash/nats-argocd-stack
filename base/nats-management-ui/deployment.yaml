apiVersion: v1
kind: ServiceAccount
metadata:
  name: nats-management-ui
  namespace: nats

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-management-config
  namespace: nats
data:
  config.json: |
    {
      "natsUrl": "nats://nats:4222",
      "tlsEnabled": true,
      "tlsCertPath": "/etc/nats-certs/tls.crt",
      "tlsKeyPath": "/etc/nats-certs/tls.key",
      "tlsCAPath": "/etc/nats-certs/ca.crt",
      "monitoring": {
        "enabled": true,
        "metricsUrl": "http://mimir-query-frontend.mimir:8080"
      }
    }

---
# Secret for NATS credentials
# In production, use Sealed Secrets or External Secrets Operator
apiVersion: v1
kind: Secret
metadata:
  name: nats-management-credentials
  namespace: nats
type: Opaque
stringData:
  username: "admin"
  password: "changeme"  # CHANGE THIS
  # Optional: use token-based auth
  # token: "your-secure-token"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats-management-ui
  namespace: nats
  labels:
    app: nats-management-ui
    app.kubernetes.io/name: nats-management-ui
    app.kubernetes.io/component: management
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nats-management-ui
  template:
    metadata:
      labels:
        app: nats-management-ui
    spec:
      serviceAccountName: nats-management-ui
      
      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      
      containers:
      # Option 1: NATS Surveyor (official monitoring UI)
      - name: surveyor
        image: natsio/nats-surveyor:0.5.1
        imagePullPolicy: IfNotPresent
        
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        
        env:
        - name: NATS_SURVEYOR_SERVERS
          value: "nats://nats.nats.svc.cluster.local:4222"
        
        # TLS configuration
        - name: NATS_SURVEYOR_TLS_CA
          value: "/etc/nats-certs/ca.crt"
        - name: NATS_SURVEYOR_TLS_CERT
          value: "/etc/nats-certs/tls.crt"
        - name: NATS_SURVEYOR_TLS_KEY
          value: "/etc/nats-certs/tls.key"
        
        # Credentials
        - name: NATS_SURVEYOR_CREDS
          value: "/etc/nats-credentials/nats.creds"
        
        # HTTP server configuration
        - name: NATS_SURVEYOR_HTTP_PORT
          value: "7777"
        
        ports:
        - name: http
          containerPort: 7777
          protocol: TCP
        
        volumeMounts:
        - name: nats-certs
          mountPath: /etc/nats-certs
          readOnly: true
        - name: credentials
          mountPath: /etc/nats-credentials
          readOnly: true
        - name: tmp
          mountPath: /tmp
        
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        
        livenessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
      
      # Option 2: NATS-Box with web interface (includes CLI tools)
      - name: nats-box
        image: natsio/nats-box:0.14.1
        imagePullPolicy: IfNotPresent
        
        command: ["/bin/sh"]
        args:
        - -c
        - |
          # Keep container running and serve basic web UI
          while true; do sleep 3600; done
        
        env:
        - name: NATS_URL
          value: "nats://nats.nats.svc.cluster.local:4222"
        
        volumeMounts:
        - name: nats-certs
          mountPath: /etc/nats-certs
          readOnly: true
        - name: credentials
          mountPath: /etc/nats-credentials
          readOnly: true
        
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
      
      volumes:
      - name: nats-certs
        secret:
          secretName: nats-tls-cert
      - name: credentials
        secret:
          secretName: nats-management-credentials
      - name: tmp
        emptyDir: {}
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: nats-management-ui
              topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: nats-management-ui
  namespace: nats
  labels:
    app: nats-management-ui
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    targetPort: 7777
    protocol: TCP
  selector:
    app: nats-management-ui

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nats-management-ui
  namespace: nats
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Optional: Basic auth for additional security
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: basic-auth
    # nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - nats-ui.example.com  # CHANGE THIS
    secretName: nats-ui-tls
  rules:
  - host: nats-ui.example.com  # CHANGE THIS
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nats-management-ui
            port:
              number: 80

---
# Optional: NetworkPolicy for security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nats-management-ui
  namespace: nats
spec:
  podSelector:
    matchLabels:
      app: nats-management-ui
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx  # Adjust based on your ingress
    ports:
    - protocol: TCP
      port: 7777
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow NATS connections
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: nats
    ports:
    - protocol: TCP
      port: 4222
  # Allow Mimir metrics
  - to:
    - namespaceSelector:
        matchLabels:
          name: mimir
    ports:
    - protocol: TCP
      port: 8080
