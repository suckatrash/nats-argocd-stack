apiVersion: apps/v1
kind: Deployment
metadata:
  name: control-plane
  namespace: control-plane
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: control-plane
  template:
    metadata:
      labels:
        app: control-plane
    spec:
      securityContext:
        fsGroup: 1000
      imagePullSecrets:
        - name: ghcr-credentials
      initContainers:
        - name: setup-ca-certs
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat /etc/ssl/certs/ca-certificates.crt /extra-ca/isrg-root-x1.crt > /ca-bundle/ca-certificates.crt
          volumeMounts:
            - name: extra-ca
              mountPath: /extra-ca
              readOnly: true
            - name: ca-bundle
              mountPath: /ca-bundle
      containers:
        - name: control-plane
          image: ghcr.io/connecteverything/control-plane:1.8.1
          command: ['/bin/sh', '/scripts/entrypoint.sh']
          env:
            - name: KMS_KEY_URL
              valueFrom:
                secretKeyRef:
                  name: control-plane-kms-key
                  key: kms-key
            - name: POSTGRES_DSN
              valueFrom:
                secretKeyRef:
                  name: control-plane-postgres-dsn
                  key: postgres-dsn
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: https
              containerPort: 8443
              protocol: TCP
          volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: tls-certs
              mountPath: /global-certs
              readOnly: true
            - name: secrets
              mountPath: /app/secrets
              readOnly: true
            - name: db-certs
              mountPath: /app/db-certs
              readOnly: true
            - name: data
              mountPath: /app/data
            - name: ca-bundle
              mountPath: /etc/ssl/certs/ca-certificates.crt
              subPath: ca-certificates.crt
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: scripts
          configMap:
            name: control-plane-entrypoint
            defaultMode: 0755
        - name: tls-certs
          secret:
            secretName: control-plane-tls
        - name: secrets
          projected:
            sources:
              - secret:
                  name: control-plane-postgres-dsn
              - secret:
                  name: control-plane-kms-key
        - name: db-certs
          secret:
            secretName: control-plane-db-client-certs
        - name: data
          persistentVolumeClaim:
            claimName: control-plane-data
        - name: extra-ca
          configMap:
            name: extra-ca-certificates
        - name: ca-bundle
          emptyDir: {}
