---
# PostgreSQL Database Instance provisioned via Crossplane
# Crossplane must be installed (wave 1) and GCP provider ready (wave 2)
# before this resource can be applied (wave 4)
apiVersion: sql.gcp.upbound.io/v1beta1
kind: DatabaseInstance
metadata:
  name: control-plane-db
  namespace: control-plane
spec:
  forProvider:
    region: us-west1
    databaseVersion: POSTGRES_16
    settings:
    - tier: db-f1-micro  # Adjust size as needed
      diskSize: 10
      diskType: PD_SSD
      ipConfiguration:
      - ipv4Enabled: true
        requireSsl: true  # SSL required as per config
        authorizedNetworks:
        - name: allow-all
          value: "0.0.0.0/0"  # Adjust to restrict access
      backupConfiguration:
      - enabled: true
        startTime: "03:00"
        pointInTimeRecoveryEnabled: true

  # Store connection details in a secret
  writeConnectionSecretToRef:
    name: control-plane-db-connection
    namespace: control-plane

  providerConfigRef:
    name: default
---
# Database: scpdata
apiVersion: sql.gcp.upbound.io/v1beta1
kind: Database
metadata:
  name: control-plane-scpdata
  namespace: control-plane
spec:
  forProvider:
    instanceRef:
      name: control-plane-db
  providerConfigRef:
    name: default
---
# User: scp
apiVersion: sql.gcp.upbound.io/v1beta1
kind: User
metadata:
  name: control-plane-scp-user
  namespace: control-plane
spec:
  forProvider:
    instanceRef:
      name: control-plane-db
    password: "changeme-use-external-secret"  # This should be replaced with ExternalSecret
  providerConfigRef:
    name: default
