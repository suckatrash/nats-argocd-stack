---
# PostgreSQL Database Instance provisioned via Crossplane
# Crossplane must be installed (wave 1) and GCP provider ready (wave 2)
# before this resource can be applied (wave 4)
# This instance is created first (sync-wave 0), then Database and User are created (sync-wave 1)
apiVersion: sql.gcp.upbound.io/v1beta1
kind: DatabaseInstance
metadata:
  name: control-plane-db
  namespace: control-plane
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  forProvider:
    region: us-west1
    databaseVersion: POSTGRES_16
    settings:
    - edition: ENTERPRISE
      tier: db-f1-micro
      diskSize: 10
      diskType: PD_SSD
      ipConfiguration:
      - ipv4Enabled: false
        privateNetwork: projects/PROJECT_ID/global/networks/default
      backupConfiguration:
      - enabled: true
        startTime: "03:00"
        pointInTimeRecoveryEnabled: true

  # Store connection details in a secret
  writeConnectionSecretToRef:
    name: control-plane-db-connection
    namespace: control-plane

  providerConfigRef:
    name: default
---
# Database: scpdata
# Created after DatabaseInstance is ready (sync-wave 1)
apiVersion: sql.gcp.upbound.io/v1beta1
kind: Database
metadata:
  name: control-plane-scpdata
  namespace: control-plane
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  forProvider:
    instanceRef:
      name: control-plane-db
  providerConfigRef:
    name: default
---
# User: control-plane-scp-user
# Created after DatabaseInstance is ready (sync-wave 1)
apiVersion: sql.gcp.upbound.io/v1beta1
kind: User
metadata:
  name: control-plane-scp-user
  namespace: control-plane
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  forProvider:
    instanceRef:
      name: control-plane-db
    passwordSecretRef:
      name: control-plane-db-password
      namespace: control-plane
      key: password
  providerConfigRef:
    name: default
