apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base resources
resources:
- ../../base/cert-manager/clusterissuer.yaml
- ../../base/nats/namespace.yaml
- ../../base/nats/certificate.yaml
- ../../base/nats/helmrelease.yaml
- ../../base/nats-management-ui/deployment.yaml
- ../../base/mimir/helmrelease.yaml
- ../../base/mimir/alertmanager-config.yaml
- ../../base/mimir/prometheus-rules/nats-rules.yaml

# Namespace for all resources
namespace: nats-prod

# Common labels for all resources
commonLabels:
  environment: production
  managed-by: argocd

# Common annotations
commonAnnotations:
  environment: production
  contact: sre@example.com
  backup: "true"

# Image tags for production (use specific versions, not latest)
images:
- name: nats
  newTag: 2.10.18-alpine  # Specific version for prod
- name: natsio/nats-surveyor
  newTag: 0.5.1

# ConfigMap generator for environment-specific config
configMapGenerator:
- name: env-config
  literals:
  - ENVIRONMENT=production
  - NATS_DOMAIN=nats.example.com
  - NATS_UI_DOMAIN=nats-ui.example.com
  - LETSENCRYPT_ISSUER=letsencrypt-prod
  - MIMIR_RETENTION=90d  # Longer retention for prod
  - LOG_LEVEL=info

# Patches for production-specific overrides
patches:
# Production NATS configuration with HA
- target:
    kind: Application
    name: nats
  patch: |-
    - op: replace
      path: /spec/source/helm/values
      value: |
        config:
          cluster:
            replicas: 3  # HA cluster
            name: nats-prod-cluster
          
          jetstream:
            enabled: true
            fileStore:
              pvc:
                size: 100Gi
                storageClassName: fast-ssd  # Use fast storage
            memStore:
              enabled: true
              maxSize: 4Gi
          
          tls:
            enabled: true
            secretName: nats-tls-cert
            verify: true
          
          limits:
            maxConnections: 100000
            maxPayload: 2MB
        
        nats:
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          
          # Production-grade affinity rules
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: nats
                topologyKey: kubernetes.io/hostname
              - labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: nats
                topologyKey: topology.kubernetes.io/zone
          
          # Node selector for dedicated nodes (optional)
          # nodeSelector:
          #   workload-type: messaging
          
          # Tolerations for tainted nodes (optional)
          # tolerations:
          # - key: messaging
          #   operator: Equal
          #   value: "true"
          #   effect: NoSchedule
        
        service:
          type: LoadBalancer
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
            service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
            # Enable deletion protection
            service.beta.kubernetes.io/aws-load-balancer-attributes: deletion_protection.enabled=true
        
        # Production monitoring
        serviceMonitor:
          enabled: true
          interval: 30s
          scrapeTimeout: 10s
        
        # Strong PDB
        podDisruptionBudget:
          enabled: true
          minAvailable: 2

# Production certificate with real domain
- target:
    kind: Certificate
    name: nats-tls
  patch: |-
    - op: replace
      path: /spec/commonName
      value: nats.example.com
    - op: replace
      path: /spec/dnsNames
      value:
      - nats.example.com
      - nats.nats-prod.svc.cluster.local
      - "*.nats-prod.svc.cluster.local"
      - nats-0.nats.nats-prod.svc.cluster.local
      - nats-1.nats.nats-prod.svc.cluster.local
      - nats-2.nats.nats-prod.svc.cluster.local
    - op: replace
      path: /spec/issuerRef/name
      value: letsencrypt-prod

# Production Mimir with distributed mode and S3
- target:
    kind: Application
    name: mimir
  patch: |-
    - op: replace
      path: /spec/source/helm/values
      value: |
        global:
          clusterDomain: cluster.local
        
        mimir:
          structuredConfig:
            blocks_storage:
              backend: s3
              s3:
                endpoint: s3.amazonaws.com
                bucket_name: mimir-blocks-prod
                region: us-east-1
                # Credentials from secret
              
              tsdb:
                retention_period: 90d  # 90 days retention
            
            limits:
              max_global_series_per_user: 10000000
              ingestion_rate: 100000
              ingestion_burst_size: 200000
            
            ruler:
              enable_api: true
              alertmanager_url: http://alertmanager:9093
              rule_path: /data/rules
        
        # Distributed components with HA
        ingester:
          replicas: 3
          resources:
            requests:
              cpu: 1000m
              memory: 4Gi
            limits:
              cpu: 4000m
              memory: 16Gi
          persistentVolume:
            size: 100Gi
            storageClassName: fast-ssd
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchLabels:
                    app.kubernetes.io/component: ingester
                topologyKey: kubernetes.io/hostname
        
        querier:
          replicas: 3
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 8Gi
        
        query_frontend:
          replicas: 3
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
        
        store_gateway:
          replicas: 3
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 8Gi
          persistentVolume:
            size: 50Gi
            storageClassName: fast-ssd
        
        compactor:
          replicas: 2
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 8Gi
          persistentVolume:
            size: 50Gi
        
        ruler:
          enabled: true
          replicas: 2
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
        
        distributor:
          replicas: 3
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
        
        alertmanager:
          enabled: true
          replicas: 3
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 1Gi
          persistentVolume:
            size: 5Gi
        
        # Disable MinIO for production (use real S3)
        minio:
          enabled: false
        
        # Production NGINX gateway
        nginx:
          enabled: true
          replicas: 3
          service:
            type: LoadBalancer
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi

# Production ingress with strict security
- target:
    kind: Ingress
    name: nats-management-ui
  patch: |-
    - op: replace
      path: /spec/tls/0/hosts
      value:
      - nats-ui.example.com
    - op: replace
      path: /spec/rules/0/host
      value: nats-ui.example.com
    - op: replace
      path: /metadata/annotations
      value:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        # Enable rate limiting
        nginx.ingress.kubernetes.io/limit-rps: "100"
        # Enable WAF (if using AWS ALB)
        # alb.ingress.kubernetes.io/wafv2-acl-arn: arn:aws:wafv2:...
        # IP whitelist (adjust as needed)
        # nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12"

# Increase management UI replicas for production
- target:
    kind: Deployment
    name: nats-management-ui
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3
    - op: add
      path: /spec/template/spec/affinity
      value:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app: nats-management-ui
            topologyKey: kubernetes.io/hostname
