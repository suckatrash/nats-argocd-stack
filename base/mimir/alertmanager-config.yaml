apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: mimir
data:
  alertmanager.yml: |
    global:
      # Global defaults
      resolve_timeout: 5m
      
      # SMTP configuration for email alerts
      smtp_from: alerts@example.com
      smtp_smarthost: smtp.example.com:587
      smtp_auth_username: alerts@example.com
      smtp_auth_password: ${SMTP_PASSWORD}
      smtp_require_tls: true
    
    # Templates for notifications
    templates:
    - '/etc/alertmanager/templates/*.tmpl'
    
    # Route tree
    route:
      # Default receiver
      receiver: 'default'
      
      # Group alerts to reduce noise
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      
      # Routes for specific alert types
      routes:
      # Critical alerts go to pagerduty and slack
      - match:
          severity: critical
        receiver: critical-alerts
        continue: false
        group_wait: 10s
        repeat_interval: 1h
      
      # Warning alerts go to slack only
      - match:
          severity: warning
        receiver: warning-alerts
        continue: false
        repeat_interval: 4h
      
      # NATS-specific alerts
      - match:
          component: nats
        receiver: nats-team
        continue: true
        routes:
        - match:
            severity: critical
          receiver: nats-oncall
      
      # JetStream alerts
      - match:
          component: jetstream
        receiver: nats-team
        continue: true
      
      # Info/debug alerts
      - match:
          severity: info
        receiver: info-alerts
        repeat_interval: 12h
    
    # Inhibition rules - suppress certain alerts when others fire
    inhibit_rules:
    # Suppress warning alerts if critical alert is firing
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'cluster', 'instance']
    
    # Suppress individual server alerts if cluster alert fires
    - source_match:
        alertname: 'NATSClusterSplitBrain'
      target_match:
        alertname: 'NATSServerDown'
      equal: ['cluster']
    
    # Receivers - configure your notification channels
    receivers:
    # Default receiver (catch-all)
    - name: 'default'
      email_configs:
      - to: 'team@example.com'
        headers:
          Subject: '[ALERT] {{ .GroupLabels.alertname }}'
    
    # Critical alerts - multiple channels
    - name: 'critical-alerts'
      # PagerDuty
      pagerduty_configs:
      - service_key: ${PAGERDUTY_SERVICE_KEY}
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        severity: '{{ .CommonLabels.severity }}'
      
      # Slack
      slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: '#alerts-critical'
        title: ':fire: Critical Alert'
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Severity:* {{ .CommonLabels.severity }}
        send_resolved: true
      
      # Email
      email_configs:
      - to: 'oncall@example.com'
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
    
    # Warning alerts - Slack only
    - name: 'warning-alerts'
      slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: '#alerts-warning'
        title: ':warning: Warning Alert'
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Severity:* {{ .CommonLabels.severity }}
        send_resolved: true
    
    # NATS team alerts
    - name: 'nats-team'
      slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: '#nats-alerts'
        title: 'NATS Alert'
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *Component:* {{ .CommonLabels.component }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
        send_resolved: true
      
      email_configs:
      - to: 'nats-team@example.com'
    
    # NATS on-call (critical only)
    - name: 'nats-oncall'
      pagerduty_configs:
      - service_key: ${PAGERDUTY_NATS_KEY}
        description: 'NATS Critical: {{ .CommonAnnotations.summary }}'
    
    # Info/debug alerts - low priority
    - name: 'info-alerts'
      slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: '#alerts-info'
        title: 'Info Alert'
        text: '{{ .CommonAnnotations.summary }}'
        send_resolved: false
    
    # Webhook receiver example (for custom integrations)
    # - name: 'webhook'
    #   webhook_configs:
    #   - url: 'http://custom-alerting-service/webhook'
    #     send_resolved: true
    #     http_config:
    #       bearer_token: ${WEBHOOK_TOKEN}
    
    # OpsGenie example
    # - name: 'opsgenie'
    #   opsgenie_configs:
    #   - api_key: ${OPSGENIE_API_KEY}
    #     tags: 'kubernetes,nats'
    #     priority: '{{ if eq .CommonLabels.severity "critical" }}P1{{ else }}P3{{ end }}'

---
# Custom alert templates (optional)
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: mimir
data:
  default.tmpl: |
    {{ define "slack.default.title" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.alertname }}
    {{ end }}
    
    {{ define "slack.default.text" }}
    {{ range .Alerts }}
    *Alert:* {{ .Labels.alertname }}
    *Severity:* {{ .Labels.severity }}
    *Summary:* {{ .Annotations.summary }}
    *Description:* {{ .Annotations.description }}
    {{ if .Labels.instance }}*Instance:* {{ .Labels.instance }}{{ end }}
    {{ if .Labels.cluster }}*Cluster:* {{ .Labels.cluster }}{{ end }}
    *Started:* {{ .StartsAt | date "2006-01-02 15:04:05" }}
    {{ end }}
    {{ end }}
    
    {{ define "email.default.subject" }}
    [{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} ({{ .Alerts.Firing | len }} firing)
    {{ end }}
    
    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .alert { border: 1px solid #ddd; margin: 10px; padding: 10px; }
        .critical { border-left: 4px solid #d9534f; }
        .warning { border-left: 4px solid #f0ad4e; }
        .info { border-left: 4px solid #5bc0de; }
      </style>
    </head>
    <body>
      <h2>Alert: {{ .GroupLabels.alertname }}</h2>
      <p><strong>Status:</strong> {{ .Status }}</p>
      {{ range .Alerts }}
      <div class="alert {{ .Labels.severity }}">
        <h3>{{ .Labels.alertname }}</h3>
        <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
        <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>
        {{ if .Labels.instance }}<p><strong>Instance:</strong> {{ .Labels.instance }}</p>{{ end }}
        <p><strong>Started:</strong> {{ .StartsAt }}</p>
      </div>
      {{ end }}
    </body>
    </html>
    {{ end }}
