apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: nats
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: https://github.com/suckatrash/nats-argocd-stack.git
        revision: HEAD
        files:
          - path: "clusters/*/config.yaml"
  template:
    metadata:
      name: '{{.cluster.name}}-nats'
      annotations:
        argocd.argoproj.io/sync-wave: "4"
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      destination:
        server: '{{.cluster.server}}'
        namespace: nats
      sources:
        - repoURL: https://nats-io.github.io/k8s/helm/charts/
          chart: nats
          targetRevision: 1.2.6
          helm:
            values: |
              config:
                cluster:
                  enabled: {{.apps.nats.cluster.enabled}}
                  replicas: {{.apps.nats.cluster.replicas}}
                  tls:
                    enabled: {{.apps.nats.cluster.tls.enabled}}
                    secretName: "{{.apps.nats.cluster.tls.secretName}}"
                jetstream:
                  enabled: {{.apps.nats.jetstream.enabled}}
                  fileStore:
                    enabled: {{.apps.nats.jetstream.fileStore.enabled}}
                    dir: "{{.apps.nats.jetstream.fileStore.dir}}"
                    pvc:
                      enabled: {{.apps.nats.jetstream.fileStore.pvc.enabled}}
                      size: "{{.apps.nats.jetstream.fileStore.pvc.size}}"
                      storageClassName: "{{.apps.nats.jetstream.fileStore.pvc.storageClassName}}"
                  memoryStore:
                    enabled: {{.apps.nats.jetstream.memoryStore.enabled}}
                    maxSize: "{{.apps.nats.jetstream.memoryStore.maxSize}}"
                  merge:
                    domain: "{{.apps.nats.jetstream.domain}}"
                nats:
                  tls:
                    enabled: {{.apps.nats.tls.enabled}}
                    secretName: "{{.apps.nats.tls.secretName}}"
                    cert: "{{.apps.nats.tls.cert}}"
                    key: "{{.apps.nats.tls.key}}"
                    merge:
                      verify: {{.apps.nats.tls.verify}}
                websocket:
                  enabled: {{.apps.nats.websocket.enabled}}
                  port: {{.apps.nats.websocket.port}}
                  tls:
                    enabled: {{.apps.nats.websocket.tls.enabled}}
                    secretName: "{{.apps.nats.websocket.tls.secretName}}"
                leafnodes:
                  enabled: {{.apps.nats.leafnodes.enabled}}
                  port: {{.apps.nats.leafnodes.port}}
                  tls:
                    enabled: {{.apps.nats.leafnodes.tls.enabled}}
                    secretName: "{{.apps.nats.leafnodes.tls.secretName}}"
                gateway:
                  enabled: {{.apps.nats.gateway.enabled}}
                  port: {{.apps.nats.gateway.port}}
                  tls:
                    enabled: {{.apps.nats.gateway.tls.enabled}}
                    secretName: "{{.apps.nats.gateway.tls.secretName}}"
                  merge:
                    name: "{{.apps.nats.gateway.name}}"
                mqtt:
                  enabled: {{.apps.nats.mqtt.enabled}}
                  port: {{.apps.nats.mqtt.port}}
                  tls:
                    enabled: {{.apps.nats.mqtt.tls.enabled}}
                    secretName: "{{.apps.nats.mqtt.tls.secretName}}"
                monitor:
                  enabled: {{.apps.nats.monitor.enabled}}
                  port: {{.apps.nats.monitor.port}}
                resolver:
                  enabled: true
                  pvc:
                    enabled: {{.apps.nats.auth.resolver.pvc.enabled}}
                    size: "{{.apps.nats.auth.resolver.pvc.size}}"
                    storageClassName: "{{.apps.nats.auth.resolver.pvc.storageClassName}}"
                  merge:
                    type: "{{.apps.nats.auth.resolver.type}}"
                    interval: "{{.apps.nats.auth.resolver.interval}}"
                    timeout: "{{.apps.nats.auth.resolver.timeout}}"
                merge:
                  operator: "{{.apps.nats.auth.operatorJwt}}"
                  system_account: "{{.apps.nats.auth.sysAccountId}}"
                  resolver_preload:
                    "{{.apps.nats.auth.sysAccountId}}": "{{.apps.nats.auth.sysAccountJwt}}"
              container:
                image:
                  repository: "{{.apps.nats.image.repository}}"
                  tag: "{{.apps.nats.image.tag}}"
                  pullPolicy: "{{.apps.nats.image.pullPolicy}}"
                merge:
                  resources:
                    requests:
                      cpu: "{{.apps.nats.resources.requests.cpu}}"
                      memory: "{{.apps.nats.resources.requests.memory}}"
                    limits:
                      cpu: "{{.apps.nats.resources.limits.cpu}}"
                      memory: "{{.apps.nats.resources.limits.memory}}"
              natsBox:
                enabled: {{.apps.nats.natsbox.enabled}}
                container:
                  image:
                    repository: "{{.apps.nats.natsbox.image.repository}}"
                    tag: "{{.apps.nats.natsbox.image.tag}}"
                    pullPolicy: "{{.apps.nats.natsbox.image.pullPolicy}}"
              service:
                enabled: true
                merge:
                  metadata:
                    annotations:
                      external-dns.alpha.kubernetes.io/hostname: "{{.apps.nats.host}}"
                  spec:
                    type: "{{.apps.nats.service.type}}"
                ports:
                  nats:
                    enabled: {{.apps.nats.service.ports.nats.enabled}}
                  leafnodes:
                    enabled: {{.apps.nats.service.ports.leafnodes.enabled}}
                  websocket:
                    enabled: {{.apps.nats.service.ports.websocket.enabled}}
                  mqtt:
                    enabled: {{.apps.nats.service.ports.mqtt.enabled}}
        - repoURL: https://github.com/suckatrash/nats-argocd-stack.git
          targetRevision: HEAD
          path: base/nats
          kustomize:
            patches:
              - target:
                  kind: Ingress
                  name: nats-monitoring
                patch: |
                  - op: replace
                    path: /spec/tls/0/hosts/0
                    value: '{{.apps.nats.monitoringHost}}'
                  - op: replace
                    path: /spec/rules/0/host
                    value: '{{.apps.nats.monitoringHost}}'
                  - op: replace
                    path: /spec/rules/0/http/paths/0/backend/service/name
                    value: '{{.cluster.name}}-nats-headless'
                  - op: replace
                    path: /metadata/annotations/cert-manager.io~1cluster-issuer
                    value: '{{.certManager.issuer}}'
              - target:
                  kind: Certificate
                  name: nats-tls
                patch: |
                  - op: replace
                    path: /spec/commonName
                    value: '{{.apps.nats.host}}'
                  - op: replace
                    path: /spec/dnsNames/0
                    value: '{{.apps.nats.host}}'
                  - op: replace
                    path: /spec/issuerRef/name
                    value: '{{.certManager.issuer}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: prometheus
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: https://github.com/suckatrash/nats-argocd-stack.git
        revision: HEAD
        files:
          - path: "clusters/*/config.yaml"
  template:
    metadata:
      name: '{{.cluster.name}}-prometheus'
      annotations:
        argocd.argoproj.io/sync-wave: "4"
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      destination:
        server: '{{.cluster.server}}'
        namespace: prometheus
      source:
        repoURL: https://prometheus-community.github.io/helm-charts
        chart: prometheus
        targetRevision: 25.11.0
        helm:
          valuesObject:
            server:
              persistentVolume:
                enabled: true
                size: 10Gi
                storageClass: standard-rwo
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
            alertmanager:
              enabled: false
            kube-state-metrics:
              enabled: true
            prometheus-node-exporter:
              enabled: true
            prometheus-pushgateway:
              enabled: false
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: control-plane
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: https://github.com/suckatrash/nats-argocd-stack.git
        revision: HEAD
        files:
          - path: "clusters/*/config.yaml"
  template:
    metadata:
      name: '{{.cluster.name}}-control-plane'
      annotations:
        argocd.argoproj.io/sync-wave: "5"
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      destination:
        server: '{{.cluster.server}}'
        namespace: control-plane
      source:
        repoURL: https://github.com/suckatrash/nats-argocd-stack.git
        targetRevision: HEAD
        path: base/control-plane
        kustomize:
          patches:
            - target:
                kind: ServiceAccount
                name: secret-generator
              patch: |
                - op: replace
                  path: /metadata/annotations/iam.gke.io~1gcp-service-account
                  value: 'external-secrets-sa@{{.gcp.project}}.iam.gserviceaccount.com'
            - target:
                kind: DatabaseInstance
                name: control-plane-db
              patch: |
                - op: replace
                  path: /spec/forProvider/region
                  value: '{{.gcp.region}}'
                - op: replace
                  path: /spec/forProvider/settings/0/ipConfiguration/0/privateNetwork
                  value: 'projects/{{.gcp.project}}/global/networks/{{.gcp.network}}'
            - target:
                kind: Ingress
                name: control-plane
              patch: |
                - op: replace
                  path: /spec/tls/0/hosts/0
                  value: '{{.apps.controlPlane.host}}'
                - op: replace
                  path: /spec/rules/0/host
                  value: '{{.apps.controlPlane.host}}'
            - target:
                kind: Certificate
                name: control-plane-tls
              patch: |
                - op: replace
                  path: /spec/dnsNames/0
                  value: '{{.apps.controlPlane.host}}'
            - target:
                kind: ConfigMap
                name: control-plane-entrypoint
              patch: |
                - op: replace
                  path: /data/entrypoint.sh
                  value: |
                    #!/bin/sh
                    set -e
                    cat > /tmp/syn-cp.yaml <<EOF
                    server:
                      url: https://{{.apps.controlPlane.host}}
                      tls:
                        cert_file: /global-certs/tls.crt
                        key_file: /global-certs/tls.key
                    data_sources:
                      postgres:
                        dsn: ${POSTGRES_DSN}
                    metrics:
                      default_scrape_interval_seconds: 30
                    kms:
                      key_url: ${KMS_KEY_URL}
                    EOF
                    exec synadia-control-plane server start -c /tmp/syn-cp.yaml
            - target:
                kind: Deployment
                name: control-plane
              patch: |
                - op: replace
                  path: /spec/template/spec/containers/0/image
                  value: '{{.apps.controlPlane.image}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: 20
          backoff:
            duration: 30s
            factor: 2
            maxDuration: 5m
