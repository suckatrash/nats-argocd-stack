---
# Crossplane Helm Release
# Replaces Terraform for managing cloud infrastructure
apiVersion: v2
kind: Application
metadata:
  name: crossplane
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-2"  # Install before External Secrets
spec:
  project: platform
  source:
    chart: crossplane
    repoURL: https://charts.crossplane.io/stable
    targetRevision: 1.14.5
    helm:
      values: |
        # Crossplane configuration
        replicas: 2
        
        deploymentStrategy: RollingUpdate
        
        image:
          repository: crossplane/crossplane
          tag: v1.14.5
          pullPolicy: IfNotPresent
        
        # Resource requests/limits
        resourcesCrossplane:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        resourcesRBACManager:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        
        # Monitoring
        metrics:
          enabled: true
        
        # Args
        args:
        - --enable-composition-revisions
        - --enable-environment-configs
        
        # RBAC
        rbacManager:
          deploy: true
          replicas: 1

  destination:
    server: https://kubernetes.default.svc
    namespace: crossplane-system
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true

---
# AWS Provider Configuration
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-aws
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  package: xpkg.upbound.io/upbound/provider-aws:v0.47.0
  packagePullPolicy: IfNotPresent

---
# GCP Provider Configuration  
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-gcp
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  package: xpkg.upbound.io/upbound/provider-gcp:v0.42.0
  packagePullPolicy: IfNotPresent

---
# Azure Provider Configuration
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-azure
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  package: xpkg.upbound.io/upbound/provider-azure:v0.39.0
  packagePullPolicy: IfNotPresent

---
# Kubernetes Provider (for in-cluster resources)
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-kubernetes
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  package: xpkg.upbound.io/crossplane-contrib/provider-kubernetes:v0.11.0
  packagePullPolicy: IfNotPresent

---
# Helm Provider (for Helm charts as infrastructure)
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-helm
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  package: xpkg.upbound.io/crossplane-contrib/provider-helm:v0.16.0
  packagePullPolicy: IfNotPresent
